<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<title>vulpix</title>
	<link rel="stylesheet" href="index.css">
	<script src="jquery-3.2.1.min.js"></script>
	<script type="text/javascript">
		var locale = "SV-sv";
		var sessionToken = null;
		var sessionUserId = null;
		var resourceId = null;
		var username = "admin";
		var password = "password";
		var mockData = [
      {
         "referenceNumber":"590323bd7569e964021500",
         "startDate":"2017-04-28T13:00:00+0000",
         "endDate":"2017-04-30T13:30:00+0000",
         "firstName":"Admin",
         "lastName":"Admin",
         "resourceName":"Innovation",
         "title":"Booking Test",
         "description":"Slowbro dude!",
         "requiresApproval":false,
         "isRecurring":false,
         "scheduleId":"1",
         "userId":"11",
         "resourceId":"1",
         "duration":"2 days 30 minutes",
         "bufferTime":"",
         "bufferedStartDate":"2017-04-28T13:00:00+0000",
         "bufferedEndDate":"2017-04-30T13:30:00+0000",
         "participants":[

         ],
         "invitees":[

         ],
         "participatingGuests":[

         ],
         "invitedGuests":null,
         "startReminder":null,
         "endReminder":null,
         "color":"",
         "textColor":"",
         "checkInDate":"",
         "checkOutDate":"",
         "originalEndDate":"",
         "isCheckInEnabled":false,
         "autoReleaseMinutes":null,
         "resourceStatusId":"1",
         "creditsConsumed":null,
         "links":[
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Resources\/1",
               "title":"get_resource"
            },
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Reservations\/590323bd7569e964021500",
               "title":"get_reservation"
            },
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Users\/11",
               "title":"get_user"
            },
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Schedules\/1",
               "title":"get_schedule"
            }
         ],
         "message":null
      },
      {
         "referenceNumber":"59034220435a5037285545",
         "startDate":"2017-04-28T13:30:00+0000",
         "endDate":"2017-04-28T14:00:00+0000",
         "firstName":"Admin",
         "lastName":"Admin",
         "resourceName":"Darkness",
         "title":"test",
         "description":"test",
         "requiresApproval":false,
         "isRecurring":false,
         "scheduleId":"1",
         "userId":"11",
         "resourceId":"11",
         "duration":"30 minutes",
         "bufferTime":"",
         "bufferedStartDate":"2017-04-28T13:30:00+0000",
         "bufferedEndDate":"2017-04-28T14:00:00+0000",
         "participants":[

         ],
         "invitees":[

         ],
         "participatingGuests":[

         ],
         "invitedGuests":null,
         "startReminder":null,
         "endReminder":null,
         "color":"#2b2b2b",
         "textColor":"#FFFFFF",
         "checkInDate":"",
         "checkOutDate":"",
         "originalEndDate":"",
         "isCheckInEnabled":false,
         "autoReleaseMinutes":null,
         "resourceStatusId":"1",
         "creditsConsumed":null,
         "links":[
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Resources\/11",
               "title":"get_resource"
            },
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Reservations\/59034220435a5037285545",
               "title":"get_reservation"
            },
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Users\/11",
               "title":"get_user"
            },
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Schedules\/1",
               "title":"get_schedule"
            }
         ],
         "message":null
      },
      {
         "referenceNumber":"590342804cb75079141131",
         "startDate":"2017-04-30T13:30:00+0000",
         "endDate":"2017-05-01T05:00:00+0000",
         "firstName":"Admin",
         "lastName":"Admin",
         "resourceName":"Innovation",
         "title":"Wish I'd taken Hobo",
         "description":"",
         "requiresApproval":false,
         "isRecurring":false,
         "scheduleId":"1",
         "userId":"11",
         "resourceId":"1",
         "duration":"15 hours 30 minutes",
         "bufferTime":"",
         "bufferedStartDate":"2017-04-30T13:30:00+0000",
         "bufferedEndDate":"2017-05-01T05:00:00+0000",
         "participants":[

         ],
         "invitees":[

         ],
         "participatingGuests":[

         ],
         "invitedGuests":null,
         "startReminder":null,
         "endReminder":null,
         "color":"",
         "textColor":"",
         "checkInDate":"",
         "checkOutDate":"",
         "originalEndDate":"",
         "isCheckInEnabled":false,
         "autoReleaseMinutes":null,
         "resourceStatusId":"1",
         "creditsConsumed":null,
         "links":[
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Resources\/1",
               "title":"get_resource"
            },
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Reservations\/590342804cb75079141131",
               "title":"get_reservation"
            },
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Users\/11",
               "title":"get_user"
            },
            {
               "href":"http:\/\/slowbro.azurewebsites.net\/Web\/Services\/index.php\/Schedules\/1",
               "title":"get_schedule"
            }
         ],
         "message":null
      }
   ];
	
		function updateTime(){
			var d = new Date();
			$("#currentTime").text(d.toLocaleTimeString(locale, {hour: "2-digit", minute: "2-digit"}));
			$("#currentDate").text(d.toLocaleDateString(locale, {month: "long", day:"numeric"}));
		};
		
		function cancelBooking(bookingId){
			console.log(bookingId);
		}
		
		function extendBooking(bookingId){
			console.log(bookingId);
		}
		
		function updateBookingView(bookingItems){
			var l = [];
			
			for(var i=0; i<bookingItems.length; i++){
				var item = bookingItems[i];
				var s = new Date(item.startDate);
				var e = new Date(item.endDate);
				l.push("<figure class='bookingItem'>");
				l.push("	<p>" + item.title + "</p>");
				l.push("	<p>" + s.toLocaleString(locale, {year: "numeric", month: "numeric", weekday: "long", day:"numeric", hour: "2-digit", minute: "2-digit"}) + "</p>");
				l.push("	<p>" + e.toLocaleString(locale, {year: "numeric", month: "numeric", weekday: "long", day:"numeric",  hour: "2-digit", minute: "2-digit"}) + "</p>");
				l.push("	<div>");
				l.push("		<button class='button cancelBookingButton' onclick='cancelBooking(\"" + item.referenceNumber + "\")'>Cancel Booking</button>");
				l.push("		<button class='button extendBookingButton' onclick='extendBooking(\"" + item.referenceNumber + "\")'>Extend Booking</button>");
				l.push("	</div>");
				l.push("</figure>");
			}
			
			$("#bookingList").html(l.join("\n"));
			//transformView();
		}
		
		function transformView(){
			var l = $(".bookingItem");
			var d = 360/l.length;
			
			for(var i=0; i<l.length; i++){
				var key = "transform";
				var value = "rotateY(" + (d*i) + "deg" + ")";
				console.log(key + ":" + value);
				$(l[i]).css(key, value);
			}
		}
		
		function fetchToken(){
			return $.ajax({
				method: "POST",
				url: "http://slowbro.azurewebsites.net/Web/Services/index.php/Authentication/Authenticate",
				cache: false,
				dataType: "json",
				contentType: "application/json; charset=utf-8",
				data: JSON.stringify({
					username: username,
					password: password
				})
			}).done(function(r) {
				if(r.isAuthenticated){
					sessionToken = r.sessionToken;
					sessionUserId = r.userId;
				}
			});
		}
		
		function fetchResourceData(){
			return $.ajax({
				method: "GET",
				url: "http://slowbro.azurewebsites.net/Web/Services/index.php/Resources/" + resourceId,
				cache: false,
				headers: {
					"X-Booked-SessionToken": sessionToken,
					"X-Booked-UserId": sessionUserId
				}
			}).done(function(r) {
				$("#roomName").text(r.name);
			});
		}
		
		function fetchReservationsData(){
			return $.ajax({
				method: "GET",
				url: "http://slowbro.azurewebsites.net/Web/Services/index.php/Reservations",
				dataType: "json",
				data: {
					resourceId: resourceId
				},
				headers: {
					"X-Booked-SessionToken": sessionToken,
					"X-Booked-UserId": sessionUserId
				}
			}).done(function(r) {
				updateBookingView(r.reservations);
			});
		}
		
		function getReservationId(){
			var array = window.location.search.substring(1).split("&");
			var argMap = {};
			
			for(var i=0; i<array.length; i++){
				var arg = array[i].split("=");
				argMap[arg[0]] = arg[1];
			}
			
			resourceId = argMap["resourceId"];
		}
		
		function phonenumberPrompt(){
			var d = $.Deferred();
			$("#phonenumberWindow").show();
			$("#phonenumberWindow .textInput").focus();
			
			$("#phonenumberWindow .cancelButton").on("click", function(){
				$("#phonenumberWindow").hide();
				d.resolve();
			});
			
			$("#phonenumberWindow .okButton").on("click", function(){
				//d.reject();
				var phonenumber = $("#phonenumberWindow .textInput").val();
				
				$("#phonenumberWindow").hide();
				d.resolve(phonenumber);
			});
			
			return d.promise();
		}
		
		function createReservation(userId){
			return $.ajax({
				method: "POST",
				url: "/Web/Services/index.php/Reservations",
				dataType: "json",
				data: {
					"resourceId": resourceId,
					"startDateTime": "2017-05-03T08:17:00-0700",
					"endDateTime": "2017-05-03T08:17:30-0700",
					"title": "title",
					"userId": 1,
					"description": "reservation description",
					"title": "reservation title",
					"recurrenceRule":{
						"type": "none"
					}
				},
				headers: {
					"X-Booked-SessionToken": sessionToken,
					"X-Booked-UserId": sessionUserId
				}
			}).done(function(r) {
				console.log(r);
			});
		}
				
		function setHandlers(){
			$(".addBookingButton").on("click", function(){
				phonenumberPrompt()
				.then(function(phonenumber){
					if(phonenumber){
						console.log(phonenumber);
					}
					else{
						console.log("cancel");
					}
				})
				.fail(showError);
			});
		}
		
		function showError(e){
			 console.log(e);
		}
	
		$(document).ready(function(){
			getReservationId();
			updateTime();
			updateBookingView(mockData);
			
			fetchToken()
			.then(fetchResourceData)
			.then(fetchReservationsData);
			
			setInterval(function(){
				updateTime();
				
				fetchReservationsData()
				.fail(fetchToken);
			}, 1000 * 60);
			
			setHandlers();
		});
	</script>
</head>
<body class="rootContainer">

<div class="container1">
	<div class="innerContainer">
		<span id="currentTime">currentTime</span>
		<span id="currentDate">currentDate</span>
	</div>
</div>

<div class="container2">
	<div class="innerContainer">
		<img id="imageLogo" src="symbio_logo.svg" alt="logo"/>
		<span id="roomName">roomName</span>
		<button id="addBookingButton" class="button addBookingButton">Add Booking</button>
	</div>
</div>

<div style="clear:both"></div>

<div class="container3">
	<div id="bookingList">
	</div>
</div>

<div id="phonenumberWindow" class="modalContainer">
	<div class="innerContainer">
		<p>Please enter your phonenumber to continue</p>
		<input type="tel" class="textInput" placeholder="0701234567"/>
		<div>
			<button class="button cancelButton">CANCEL</button>
			<button class="button okButton">OK</button>
		</div>
	</div>
</div>

<div id="addBookingWindow" class="modalContainer">
	<div class="innerContainer">
		<p>Add Booking</p>
	</div>
</div>

</body>
</html>
